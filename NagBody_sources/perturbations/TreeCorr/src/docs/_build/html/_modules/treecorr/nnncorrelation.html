<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>treecorr.nnncorrelation &mdash; TreeCorr 4.2.8 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> TreeCorr
          </a>
              <div class="version">
                4.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../catalog.html">Input Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlation2.html">Two-point Correlation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlation3.html">Three-point Correlation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metric.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binning.html">Binning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../patches.html">Patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cov.html">Covariance Estimates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../field.html">Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts.html">Using configuration files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Changes from version 4.1 to 4.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-0-to-4-2-1">Changes from version 4.2.0 to 4.2.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-1-to-4-2-2">Changes from version 4.2.1 to 4.2.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-2-to-4-2-3">Changes from version 4.2.2 to 4.2.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-3-to-4-2-4">Changes from version 4.2.3 to 4.2.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-4-to-4-2-5">Changes from version 4.2.4 to 4.2.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-5-to-4-2-6">Changes from version 4.2.5 to 4.2.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-6-to-4-2-7">Changes from version 4.2.6 to 4.2.7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-7-to-4-2-8">Changes from version 4.2.7 to 4.2.8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Previous History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TreeCorr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>treecorr.nnncorrelation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for treecorr.nnncorrelation</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2003-2019 by Mike Jarvis</span>
<span class="c1">#</span>
<span class="c1"># TreeCorr is free software: redistribution and use in source and binary forms,</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions, and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions, and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: nnncorrelation</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_lib</span><span class="p">,</span> <span class="n">_ffi</span>
<span class="kn">from</span> <span class="nn">.binnedcorr3</span> <span class="kn">import</span> <span class="n">BinnedCorr3</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">double_ptr</span> <span class="k">as</span> <span class="n">dp</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">gen_read</span><span class="p">,</span> <span class="n">gen_write</span><span class="p">,</span> <span class="n">gen_multi_read</span><span class="p">,</span> <span class="n">gen_multi_write</span><span class="p">,</span> <span class="n">lazy_property</span>

<div class="viewcode-block" id="NNNCorrelation"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation">[docs]</a><span class="k">class</span> <span class="nc">NNNCorrelation</span><span class="p">(</span><span class="n">BinnedCorr3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class handles the calculation and storage of a 2-point count-count correlation</span>
<span class="sd">    function.  i.e. the regular density correlation function.</span>

<span class="sd">    See the doc string of `BinnedCorr3` for a description of how the triangles are binned.</span>

<span class="sd">    Ojects of this class holds the following attributes:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        logr:       The nominal center of the bin in log(r) (the natural logarithm of r).</span>
<span class="sd">        nbins:      The number of bins in logr where r = d2</span>
<span class="sd">        bin_size:   The size of the bins in logr</span>
<span class="sd">        min_sep:    The minimum separation being considered</span>
<span class="sd">        max_sep:    The maximum separation being considered</span>
<span class="sd">        nubins:     The number of bins in u where u = d3/d2</span>
<span class="sd">        ubin_size:  The size of the bins in u</span>
<span class="sd">        min_u:      The minimum u being considered</span>
<span class="sd">        max_u:      The maximum u being considered</span>
<span class="sd">        nvbins:     The number of bins in v where v = +-(d1-d2)/d3</span>
<span class="sd">        vbin_size:  The size of the bins in v</span>
<span class="sd">        min_v:      The minimum v being considered</span>
<span class="sd">        max_v:      The maximum v being considered</span>
<span class="sd">        logr1d:     The nominal centers of the nbins bins in log(r).</span>
<span class="sd">        u1d:        The nominal centers of the nubins bins in u.</span>
<span class="sd">        v1d:        The nominal centers of the nvbins bins in v.</span>

<span class="sd">    In addition, the following attributes are numpy arrays whose shape is (nbins, nubins, nvbins):</span>

<span class="sd">    Attributes:</span>
<span class="sd">        logr:       The nominal center of the bin in log(r).</span>
<span class="sd">        rnom:       The nominal center of the bin converted to regular distance.</span>
<span class="sd">                    i.e. r = exp(logr).</span>
<span class="sd">        u:          The nominal center of the bin in u.</span>
<span class="sd">        v:          The nominal center of the bin in v.</span>
<span class="sd">        meand1:     The (weighted) mean value of d1 for the triangles in each bin.</span>
<span class="sd">        meanlogd1:  The mean value of log(d1) for the triangles in each bin.</span>
<span class="sd">        meand2:     The (weighted) mean value of d2 (aka r) for the triangles in each bin.</span>
<span class="sd">        meanlogd2:  The mean value of log(d2) for the triangles in each bin.</span>
<span class="sd">        meand2:     The (weighted) mean value of d3 for the triangles in each bin.</span>
<span class="sd">        meanlogd2:  The mean value of log(d3) for the triangles in each bin.</span>
<span class="sd">        meanu:      The mean value of u for the triangles in each bin.</span>
<span class="sd">        meanv:      The mean value of v for the triangles in each bin.</span>
<span class="sd">        weight:     The total weight in each bin.</span>
<span class="sd">        ntri:       The number of triangles going into each bin (including those where one or</span>
<span class="sd">                    more objects have w=0).</span>
<span class="sd">        tot:        The total number of triangles processed, which is used to normalize</span>
<span class="sd">                    the randoms if they have a different number of triangles.</span>

<span class="sd">    If ``sep_units`` are given (either in the config dict or as a named kwarg) then the distances</span>
<span class="sd">    will all be in these units.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If you separate out the steps of the `process` command and use `process_auto` and/or</span>
<span class="sd">        `process_cross`, then the units will not be applied to ``meanr`` or ``meanlogr`` until</span>
<span class="sd">        the `finalize` function is called.</span>

<span class="sd">    The typical usage pattern is as follows:</span>

<span class="sd">        &gt;&gt;&gt; nnn = treecorr.NNNCorrelation(config)</span>
<span class="sd">        &gt;&gt;&gt; nnn.process(cat)         # For auto-correlation.</span>
<span class="sd">        &gt;&gt;&gt; rrr.process(rand)        # Likewise for random-random correlations</span>
<span class="sd">        &gt;&gt;&gt; drr.process(cat,rand)    # If desired, also do data-random correlations</span>
<span class="sd">        &gt;&gt;&gt; rdd.process(rand,cat)    # Also with two data and one random</span>
<span class="sd">        &gt;&gt;&gt; nnn.write(file_name,rrr,drr,...)  # Write out to a file.</span>
<span class="sd">        &gt;&gt;&gt; zeta,varzeta = nnn.calculateZeta(rrr,drr,rdd)  # Or get the 3pt function directly.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        config (dict):  A configuration dict that can be used to pass in kwargs if desired.</span>
<span class="sd">                        This dict is allowed to have addition entries besides those listed</span>
<span class="sd">                        in `BinnedCorr3`, which are ignored here. (default: None)</span>
<span class="sd">        logger:         If desired, a logger object for logging. (default: None, in which case</span>
<span class="sd">                        one will be built according to the config dict&#39;s verbose level.)</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        **kwargs:       See the documentation for `BinnedCorr3` for the list of allowed keyword</span>
<span class="sd">                        arguments, which may be passed either directly or in the config dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="NNNCorrelation.__init__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize `NNNCorrelation`.  See class doc for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">BinnedCorr3</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d1</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># NData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d2</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># NData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d3</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># NData</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logr</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrr_weight</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished building NNNCorr&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">BuildCorr3</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_d1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_min_sep</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_sep</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span><span class="p">,</span>
                    <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">),</span>
                    <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">),</span>
                    <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">),</span> <span class="n">dp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Using memory allocated from the C layer means we have to explicitly deallocate it</span>
        <span class="c1"># rather than being able to rely on the Python memory manager.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_ffi</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span> <span class="c1"># pragma: no branch</span>
                <span class="n">_lib</span><span class="o">.</span><span class="n">DestroyCorr3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">)</span>

<div class="viewcode-block" id="NNNCorrelation.__eq__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.__eq__">[docs]</a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether two `NNNCorrelation` instances are equal&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NNNCorrelation</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nbins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bin_size</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_sep</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_sep</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">sep_units</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_u</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_u</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nubins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ubin_size</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_v</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_v</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nvbins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">vbin_size</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bin_slop</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">xperiod</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">yperiod</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">zperiod</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tot</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meand1</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meand2</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meand3</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanu</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanv</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ntri</span><span class="p">))</span></div>

<div class="viewcode-block" id="NNNCorrelation.copy"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a copy&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">NNNCorrelation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="c1"># Only items that might change need to by deep copied.</span>
                <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For everything else, shallow copy is fine.</span>
                <span class="c1"># In particular don&#39;t deep copy config or logger</span>
                <span class="c1"># Most of the rest are scalars, which copy fine this way.</span>
                <span class="c1"># And the read-only things are all in _ro.</span>
                <span class="c1"># The results dict is trickier.  We rely on it being copied in places, but we</span>
                <span class="c1"># never add more to it after the copy, so shallow copy is fine.</span>
                <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># We&#39;ll want to make a new one of these if we need it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_drr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_rrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_zero_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># An array of all zeros with the same shape as self.weight (and other data arrays)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Just to make sure we get an error if we try to change it.</span>
        <span class="k">return</span> <span class="n">z</span>

    <span class="k">def</span> <span class="nf">_zero_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tot</span><span class="p">):</span>
        <span class="c1"># A minimal &quot;copy&quot; with zero for the weight array, and the given value for tot.</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">NNNCorrelation</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">ntri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero_array</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero_array</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="n">tot</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># This override is really the main advantage of using this:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s1">&#39;_nonzero&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="NNNCorrelation.__repr__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;NNNCorrelation(config=</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span></div>

<div class="viewcode-block" id="NNNCorrelation.process_auto"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.process_auto">[docs]</a>    <span class="k">def</span> <span class="nf">process_auto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a single catalog, accumulating the auto-correlation.</span>

<span class="sd">        This accumulates the auto-correlation for the given catalog.  After</span>
<span class="sd">        calling this function as often as desired, the `finalize` command will</span>
<span class="sd">        finish the calculation of meand1, meanlogd1, etc.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat (Catalog):      The catalog to process</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cat</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN auto-correlations&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN auto-correlations for cat </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">field</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                              <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">field</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">ProcessAuto3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                          <span class="n">field</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span> <span class="o">*</span> <span class="n">cat</span><span class="o">.</span><span class="n">sumw</span><span class="o">**</span><span class="mi">3</span></div>

<div class="viewcode-block" id="NNNCorrelation.process_cross12"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.process_cross12">[docs]</a>    <span class="k">def</span> <span class="nf">process_cross12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process two catalogs, accumulating the 3pt cross-correlation, where one of the</span>
<span class="sd">        points in each triangle come from the first catalog, and two come from the second.</span>

<span class="sd">        This accumulates the cross-correlation for the given catalogs as part of a larger</span>
<span class="sd">        auto-correlation calculation.  E.g. when splitting up a large catalog into patches,</span>
<span class="sd">        this is appropriate to use for the cross correlation between different patches</span>
<span class="sd">        as part of the complete auto-correlation of the full catalog.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     The first catalog to process. (1 point in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            cat2 (Catalog):     The second catalog to process. (2 points in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN (1-2) cross-correlations&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN (1-2) cross-correlations for cats </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">cat2</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">f1</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="c1"># Note: all 3 correlation objects are the same.  Thus, all triangles will be placed</span>
        <span class="c1"># into self.corr, whichever way the three catalogs are permuted for each triangle.</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">ProcessCross12</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span>
                            <span class="n">f1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                            <span class="n">f1</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">cat2</span><span class="o">.</span><span class="n">sumw</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span></div>

<div class="viewcode-block" id="NNNCorrelation.process_cross"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.process_cross">[docs]</a>    <span class="k">def</span> <span class="nf">process_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a set of three catalogs, accumulating the 3pt cross-correlation.</span>

<span class="sd">        This accumulates the cross-correlation for the given catalogs as part of a larger</span>
<span class="sd">        auto-correlation calculation.  E.g. when splitting up a large catalog into patches,</span>
<span class="sd">        this is appropriate to use for the cross correlation between different patches</span>
<span class="sd">        as part of the complete auto-correlation of the full catalog.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     The first catalog to process</span>
<span class="sd">            cat2 (Catalog):     The second catalog to process</span>
<span class="sd">            cat3 (Catalog):     The third catalog to process</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat3</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN cross-correlations&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN cross-correlations for cats </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat3</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat3</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">cat2</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">cat3</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">f1</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="c1"># Note: all 6 correlation objects are the same.  Thus, all triangles will be placed</span>
        <span class="c1"># into self.corr, whichever way the three catalogs are permuted for each triangle.</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">ProcessCross3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span>
                           <span class="n">f1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f3</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                           <span class="n">f1</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="n">f3</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">cat2</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">cat3</span><span class="o">.</span><span class="n">sumw</span></div>

    <span class="k">def</span> <span class="nf">_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>

        <span class="c1"># Update the units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_units</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span>

        <span class="c1"># Use meanlogr when available, but set to nominal when no triangles in bin.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logr</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span>

<div class="viewcode-block" id="NNNCorrelation.finalize"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalize the calculation of meand1, meanlogd1, etc.</span>

<span class="sd">        The `process_auto` and `process_cross` commands accumulate values in each bin,</span>
<span class="sd">        so they can be called multiple times if appropriate.  Afterwards, this command</span>
<span class="sd">        finishes the calculation of meanlogr, meanu, meanv by dividing by the total weight.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The lazy version when we can be sure the object isn&#39;t going to accumulate any more.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span>

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the data vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">def</span> <span class="nf">_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">):</span>
        <span class="c1"># Equivalent to the operation of:</span>
        <span class="c1">#     self._clear()</span>
        <span class="c1">#     for other in others:</span>
        <span class="c1">#         self += other</span>
        <span class="c1"># but no sanity checks and use numpy.sum for faster calculation.</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">tot</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">])</span>
        <span class="c1"># Empty ones were only needed for tot.  Remove them now.</span>
        <span class="n">others</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">_nonzero</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">others</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meand1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meanlogd1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meand2</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meanlogd2</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meand3</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meanu</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">meanv</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">ntri</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="n">tot</span>

    <span class="k">def</span> <span class="nf">_add_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
        <span class="c1"># When storing results from a patch-based run, tot needs to be accumulated even if</span>
        <span class="c1"># the total weight being accumulated comes out to be zero.</span>
        <span class="c1"># This only applies to NNNCorrelation.  For the other ones, this is a no op.</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">c2</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">c3</span><span class="o">.</span><span class="n">sumw</span>
        <span class="k">if</span> <span class="n">c2</span> <span class="ow">is</span> <span class="n">c3</span><span class="p">:</span>
            <span class="c1"># Account for 1/2 factor in cross12 cases.</span>
            <span class="n">tot</span> <span class="o">/=</span> <span class="mf">2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span>
        <span class="c1"># We also have to keep all pairs in the results dict, otherwise the tot calculation</span>
        <span class="c1"># gets messed up.  We need to accumulate the tot value of all pairs, even if</span>
        <span class="c1"># the resulting weight is zero.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>

<div class="viewcode-block" id="NNNCorrelation.__iadd__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.__iadd__">[docs]</a>    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a second `NNNCorrelation`&#39;s data to this one.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For this to make sense, both `NNNCorrelation` objects should not have had `finalize`</span>
<span class="sd">            called yet.  Then, after adding them together, you should call `finalize` on the sum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NNNCorrelation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can only add another NNNCorrelation object&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nbins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_sep</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_sep</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nubins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_u</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_u</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nvbins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_v</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;NNNCorrelation to be added is not compatible with this one.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">tot</span>

        <span class="c1"># If other is empty, then we&#39;re done now.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanv</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="NNNCorrelation.process"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cat3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Accumulate the 3pt correlation of the points in the given Catalog(s).</span>

<span class="sd">        - If only 1 argument is given, then compute an auto-correlation function.</span>
<span class="sd">        - If 2 arguments are given, then compute a cross-correlation function with the</span>
<span class="sd">          first catalog taking one corner of the triangles, and the second taking two corners.</span>
<span class="sd">        - If 3 arguments are given, then compute a three-way cross-correlation.</span>

<span class="sd">        All arguments may be lists, in which case all items in the list are used</span>
<span class="sd">        for that element of the correlation.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For a correlation of multiple catalogs, it typically matters which corner of the</span>
<span class="sd">            triangle comes from which catalog, which is not kept track of by this function.</span>
<span class="sd">            The final accumulation will have d1 &gt; d2 &gt; d3 regardless of which input catalog</span>
<span class="sd">            appears at each corner.  The class which keeps track of which catalog appears</span>
<span class="sd">            in each position in the triangle is `NNNCrossCorrelation`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     A catalog or list of catalogs for the first N field.</span>
<span class="sd">            cat2 (Catalog):     A catalog or list of catalogs for the second N field.</span>
<span class="sd">                                (default: None)</span>
<span class="sd">            cat3 (Catalog):     A catalog or list of catalogs for the third N field.</span>
<span class="sd">                                (default: None)</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">            comm (mpi4py.Comm): If running MPI, an mpi4py Comm object to communicate between</span>
<span class="sd">                                processes.  If used, the rank=0 process will have the final</span>
<span class="sd">                                computation. This only works if using patches. (default: None)</span>
<span class="sd">            low_mem (bool):     Whether to sacrifice a little speed to try to reduce memory usage.</span>
<span class="sd">                                This only works if using patches. (default: False)</span>
<span class="sd">            initialize (bool):  Whether to begin the calculation with a call to</span>
<span class="sd">                                `BinnedCorr3.clear`.  (default: True)</span>
<span class="sd">            finalize (bool):    Whether to complete the calculation with a call to `finalize`.</span>
<span class="sd">                                (default: True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">cat1</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">get_patches</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">cat2</span> <span class="o">=</span> <span class="n">cat2</span><span class="o">.</span><span class="n">get_patches</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat3</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">cat3</span> <span class="o">=</span> <span class="n">cat3</span><span class="o">.</span><span class="n">get_patches</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cat2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For two catalog case, use cat1,cat2, not cat1,cat3&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_auto</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_cross12</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_cross</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">finalize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_mean_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mean_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">mean_np</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">/</span><span class="n">mean_np</span>

<div class="viewcode-block" id="NNNCorrelation.getStat"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.getStat">[docs]</a>    <span class="k">def</span> <span class="nf">getStat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The standard statistic for the current correlation object as a 1-d array.</span>

<span class="sd">        This raises a RuntimeError if calculateZeta has not been run yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You need to call calculateZeta before calling estimate_cov.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>

<div class="viewcode-block" id="NNNCorrelation.getWeight"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.getWeight">[docs]</a>    <span class="k">def</span> <span class="nf">getWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The weight array for the current correlation object as a 1-d array.</span>

<span class="sd">        This is the weight array corresponding to `getStat`.  In this case, it is the denominator</span>
<span class="sd">        RRR from the calculation done by calculateZeta().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr_weight</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot</span></div>

<div class="viewcode-block" id="NNNCorrelation.calculateZeta"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.calculateZeta">[docs]</a>    <span class="k">def</span> <span class="nf">calculateZeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">drr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rdd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the 3pt function given another 3pt function of random</span>
<span class="sd">        points using the same mask, and possibly cross correlations of the data and random.</span>

<span class="sd">        There are two possible formulae that are currently supported.</span>

<span class="sd">        1. The simplest formula to use is :math:`\zeta^\prime = (DDD-RRR)/RRR`.</span>
<span class="sd">           In this case, only rrr needs to be given, the `NNNCorrelation` of a random field.</span>
<span class="sd">           However, note that in this case, the return value is not normally called :math:`\zeta`.</span>
<span class="sd">           Rather, this is an estimator of</span>

<span class="sd">           .. math::</span>

<span class="sd">               \zeta^\prime(d_1,d_2,d_3) = \zeta(d_1,d_2,d_3) + \xi(d_1) + \xi(d_2) + \xi(d_3)</span>

<span class="sd">           where :math:`\xi` is the two-point correlation function for each leg of the triangle.</span>
<span class="sd">           You would typically want to calculate that separately and subtract off the</span>
<span class="sd">           two-point contributions.</span>

<span class="sd">        2. For auto-correlations, a better formula is :math:`\zeta = (DDD-RDD+DRR-RRR)/RRR`.</span>
<span class="sd">           In this case, RDD is the number of triangles where 1 point comes from the randoms</span>
<span class="sd">           and 2 points are from the data. Similarly, DRR has 1 point from the data and 2 from</span>
<span class="sd">           the randoms.  These are what are calculated from calling::</span>

<span class="sd">                &gt;&gt;&gt; drr.process(data_cat, rand_cat)</span>
<span class="sd">                &gt;&gt;&gt; rdd.process(rand_cat, data_cat)</span>

<span class="sd">           .. note::</span>

<span class="sd">                One might thing the formula should be :math:`\zeta = (DDD-3RDD+3DRR-RRR)/RRR`</span>
<span class="sd">                by analogy with the 2pt Landy-Szalay formula. However, the way these are</span>
<span class="sd">                calculated, the object we are calling RDD already includes triangles where R</span>
<span class="sd">                is in each of the 3 locations.  So it is really more like RDD + DRD + DDR.</span>
<span class="sd">                These are not computed separately.  Rather the single computation of ``rdd``</span>
<span class="sd">                described above accumulates all three permutations together.  So that one</span>
<span class="sd">                object includes everything for the second term.  Likewise ``drr`` has all the</span>
<span class="sd">                permutations that are relevant for the third term.</span>

<span class="sd">        - If only rrr is provided, the first formula will be used.</span>
<span class="sd">        - If all of rrr, drr, rdd are provided then the second will be used.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            rrr (NNNCorrelation):   The auto-correlation of the random field (RRR)</span>
<span class="sd">            drr (NNNCorrelation):   DRR if desired. (default: None)</span>
<span class="sd">            rdd (NNNCorrelation):   RDD if desired. (default: None)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple containing</span>

<span class="sd">                - zeta = array of :math:`\zeta(d_1,d_2,d_3)`</span>
<span class="sd">                - varzeta = array of variance estimates of :math:`\zeta(d_1,d_2,d_3)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Each random ntri value needs to be rescaled by the ratio of total possible tri.</span>
        <span class="k">if</span> <span class="n">rrr</span><span class="o">.</span><span class="n">tot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rrr has tot=0.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Must provide both rdd and drr (or neither).&quot;</span><span class="p">)</span>

        <span class="c1"># rrrf is the factor to scale rrr weights to get something commensurate to the ddd density.</span>
        <span class="n">rrrf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">/</span> <span class="n">rrr</span><span class="o">.</span><span class="n">tot</span>

        <span class="c1"># Likewise for the other two potential randoms:</span>
        <span class="k">if</span> <span class="n">drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">drr</span><span class="o">.</span><span class="n">tot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;drr has tot=0.&quot;</span><span class="p">)</span>
            <span class="n">drrf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">/</span> <span class="n">drr</span><span class="o">.</span><span class="n">tot</span>
        <span class="k">if</span> <span class="n">rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rdd</span><span class="o">.</span><span class="n">tot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rdd has tot=0.&quot;</span><span class="p">)</span>
            <span class="n">rddf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">/</span> <span class="n">rdd</span><span class="o">.</span><span class="n">tot</span>

        <span class="c1"># Calculate zeta based on which randoms are provided.</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">rrr</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">rrrf</span>
        <span class="k">if</span> <span class="n">rdd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">-</span> <span class="n">denom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">-</span> <span class="n">rdd</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">rddf</span> <span class="o">+</span> <span class="n">drr</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">drrf</span> <span class="o">-</span> <span class="n">denom</span>

        <span class="c1"># Divide by DRR in all cases.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rrr</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: Some bins for the randoms had no triangles.&quot;</span><span class="p">)</span>
            <span class="n">denom</span><span class="p">[</span><span class="n">rrr</span><span class="o">.</span><span class="n">weight</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># guard against division by 0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span> <span class="o">/=</span> <span class="n">denom</span>

        <span class="c1"># Set up necessary info for estimate_cov</span>

        <span class="c1"># First the bits needed for shot noise covariance:</span>
        <span class="n">dddw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_weight</span><span class="p">()</span>
        <span class="n">rrrw</span> <span class="o">=</span> <span class="n">rrr</span><span class="o">.</span><span class="n">_mean_weight</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">drrw</span> <span class="o">=</span> <span class="n">drr</span><span class="o">.</span><span class="n">_mean_weight</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rddw</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">_mean_weight</span><span class="p">()</span>

        <span class="c1"># Note: The use of varzeta_factor for the shot noise varzeta is even less justified</span>
        <span class="c1">#       than in the NN varxi case.  This is merely motivated by analogy with the</span>
        <span class="c1">#       2pt version.</span>
        <span class="k">if</span> <span class="n">rdd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">varzeta_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rrrf</span><span class="o">*</span><span class="n">rrrw</span><span class="o">/</span><span class="n">dddw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">varzeta_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">drrf</span><span class="o">*</span><span class="n">drrw</span><span class="o">/</span><span class="n">dddw</span> <span class="o">+</span> <span class="n">rddf</span><span class="o">*</span><span class="n">rddw</span><span class="o">/</span><span class="n">dddw</span> <span class="o">+</span> <span class="n">rrrf</span><span class="o">*</span><span class="n">rrrw</span><span class="o">/</span><span class="n">dddw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var_num</span> <span class="o">=</span> <span class="n">dddw</span> <span class="o">*</span> <span class="n">varzeta_factor</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Should this be **3? Hmm...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrr_weight</span> <span class="o">=</span> <span class="n">rrr</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">rrrf</span>

        <span class="c1"># Now set up the bits needed for patch-based covariance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span> <span class="o">=</span> <span class="n">rrr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span> <span class="o">=</span> <span class="n">drr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span> <span class="o">=</span> <span class="n">rdd</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Check that all use the same patches as ddd</span>
            <span class="k">if</span> <span class="n">rrr</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rrr</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;If using patches, RRR must be run with the same patches &quot;</span>
                                       <span class="s2">&quot;as DDD&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drr</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">drr</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
                                    <span class="ow">or</span> <span class="n">drr</span><span class="o">.</span><span class="n">npatch2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;DRR must be run with the same patches as DDD&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rdd</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rdd</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                                    <span class="ow">or</span> <span class="n">rdd</span><span class="o">.</span><span class="n">npatch1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;RDD must be run with the same patches as DDD&quot;</span><span class="p">)</span>

            <span class="c1"># If there are any rrr,drr,rdd patch sets that aren&#39;t in results, then we need to add</span>
            <span class="c1"># some dummy results to make sure all the right ijk &quot;pair&quot;s are computed when we make</span>
            <span class="c1"># the vectors for the covariance matrix.</span>
            <span class="n">add_ijk</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rrr</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">rrr</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ijk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="n">add_ijk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ijk</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">drr</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">drr</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ijk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="n">add_ijk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ijk</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rdd</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">rdd</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ijk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="n">add_ijk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ijk</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_ijk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">add_ijk</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ijk</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_ok&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># If it was already made, it will need to be redone.</span>

        <span class="c1"># Now that it&#39;s all set up, calculate the covariance and set varzeta to the diagonal.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varzeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zeta</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varzeta</span></div>

    <span class="k">def</span> <span class="nf">_calculate_xi_from_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
        <span class="c1"># Note: we keep the notation ij and pairs here, even though they are really ijk and</span>
        <span class="c1"># triples.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ij</span><span class="p">]</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">ddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># This is the usual case.  R has patches just like D.</span>
            <span class="c1"># Calculate rrr and rrrf in the normal way based on the same pairs as used for DDD.</span>
            <span class="n">pairs1</span> <span class="o">=</span> <span class="p">[</span><span class="n">ij</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span><span class="o">.</span><span class="n">_sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ij</span><span class="p">]</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs1</span><span class="p">])</span>
            <span class="n">ddd_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># In this case, R was not run with patches.</span>
            <span class="c1"># We need to scale RRR down by the relative area.</span>
            <span class="c1"># The approximation we&#39;ll use is that tot in the auto-correlations is</span>
            <span class="c1"># proportional to area**3.</span>
            <span class="c1"># The sum of tot**(1/3) when i=j=k gives an estimate of the fraction of the total area.</span>
            <span class="n">area_frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ij</span><span class="p">]</span><span class="o">.</span><span class="n">tot</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span>
                                <span class="k">if</span> <span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="n">area_frac</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cij</span><span class="o">.</span><span class="n">tot</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="k">for</span> <span class="n">ij</span><span class="p">,</span><span class="n">cij</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="c1"># First figure out the original total for all DDD that had the same footprint as RRR.</span>
            <span class="n">ddd_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ij</span><span class="p">]</span><span class="o">.</span><span class="n">tot</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">])</span>
            <span class="c1"># The rrrf we want will be a factor of area_frac smaller than the original</span>
            <span class="c1"># ddd_tot/rrr_tot.  We can effect this by multiplying the full ddd_tot by area_frac</span>
            <span class="c1"># and use that value normally below.  (Also for drrf and rddf.)</span>
            <span class="n">ddd_tot</span> <span class="o">*=</span> <span class="n">area_frac</span>

        <span class="n">rrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span><span class="o">.</span><span class="n">weight</span>
        <span class="n">rrrf</span> <span class="o">=</span> <span class="n">ddd_tot</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrr</span><span class="o">.</span><span class="n">tot</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If r doesn&#39;t have patches, then convert all (i,i,i) pairs to (i,0,0).</span>
                <span class="n">pairs2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pairs2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ij</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span><span class="o">.</span><span class="n">_sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_drr</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ij</span><span class="p">]</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs2</span><span class="p">])</span>
            <span class="n">drr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span><span class="o">.</span><span class="n">weight</span>
            <span class="n">drrf</span> <span class="o">=</span> <span class="n">ddd_tot</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span><span class="o">.</span><span class="n">tot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If r doesn&#39;t have patches, then convert all (i,i,j) pairs to (0,i,j)</span>
                <span class="c1"># and all (i,j,i to (0,j,i).</span>
                <span class="n">pairs3</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pairs3</span> <span class="o">=</span> <span class="p">[</span><span class="n">ij</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ij</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span><span class="o">.</span><span class="n">_sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ij</span><span class="p">]</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs3</span><span class="p">])</span>
            <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span><span class="o">.</span><span class="n">weight</span>
            <span class="n">rddf</span> <span class="o">=</span> <span class="n">ddd_tot</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdd</span><span class="o">.</span><span class="n">tot</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">rrr</span> <span class="o">*</span> <span class="n">rrrf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="n">ddd</span> <span class="o">-</span> <span class="n">denom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="n">ddd</span> <span class="o">-</span> <span class="n">rdd</span> <span class="o">*</span> <span class="n">rddf</span> <span class="o">+</span> <span class="n">drr</span> <span class="o">*</span> <span class="n">drrf</span> <span class="o">-</span> <span class="n">denom</span>
        <span class="n">denom</span><span class="p">[</span><span class="n">denom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Guard against division by zero.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span> <span class="o">=</span> <span class="n">zeta</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrr_weight</span> <span class="o">=</span> <span class="n">denom</span>

<div class="viewcode-block" id="NNNCorrelation.write"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">rrr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rdd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write the correlation function to the file, file_name.</span>

<span class="sd">        Normally, at least rrr should be provided, but if this is None, then only the</span>
<span class="sd">        basic accumulated number of triangles are output (along with the columns parametrizing</span>
<span class="sd">        the size and shape of the triangles).</span>

<span class="sd">        If at least rrr is given, then it will output an estimate of the final 3pt correlation</span>
<span class="sd">        function, :math:`\zeta`. There are two possible formulae that are currently supported.</span>

<span class="sd">        1. The simplest formula to use is :math:`\zeta^\prime = (DDD-RRR)/RRR`.</span>
<span class="sd">           In this case, only rrr needs to be given, the `NNNCorrelation` of a random field.</span>
<span class="sd">           However, note that in this case, the return value is not what is normally called</span>
<span class="sd">           :math:`\zeta`.  Rather, this is an estimator of</span>

<span class="sd">           .. math::</span>
<span class="sd">               \zeta^\prime(d_1,d_2,d_3) = \zeta(d_1,d_2,d_3) + \xi(d_1) + \xi(d_2) + \xi(d_3)</span>

<span class="sd">           where :math:`\xi` is the two-point correlation function for each leg of the triangle.</span>
<span class="sd">           You would typically want to calculate that separately and subtract off the</span>
<span class="sd">           two-point contributions.</span>

<span class="sd">        2. For auto-correlations, a better formula is :math:`\zeta = (DDD-RDD+DRR-RRR)/RRR`.</span>
<span class="sd">           In this case, RDD is the number of triangles where 1 point comes from the randoms</span>
<span class="sd">           and 2 points are from the data. Similarly, DRR has 1 point from the data and 2 from</span>
<span class="sd">           the randoms.</span>
<span class="sd">           For this case, all combinations rrr, drr, and rdd must be provided.</span>

<span class="sd">        The output file will include the following columns:</span>

<span class="sd">        ==========      ================================================================</span>
<span class="sd">        Column          Description</span>
<span class="sd">        ==========      ================================================================</span>
<span class="sd">        r_nom           The nominal center of the bin in r = d2 where d1 &gt; d2 &gt; d3</span>
<span class="sd">        u_nom           The nominal center of the bin in u = d3/d2</span>
<span class="sd">        v_nom           The nominal center of the bin in v = +-(d1-d2)/d3</span>
<span class="sd">        meand1          The mean value :math:`\langle d1\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanlogd1       The mean value :math:`\langle \log(d1)\rangle` of triangles that</span>
<span class="sd">                        fell into each bin</span>
<span class="sd">        meand2          The mean value :math:`\langle d2\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanlogd2       The mean value :math:`\langle \log(d2)\rangle` of triangles that</span>
<span class="sd">                        fell into each bin</span>
<span class="sd">        meand3          The mean value :math:`\langle d3\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanlogd3       The mean value :math:`\langle \log(d3)\rangle` of triangles that</span>
<span class="sd">                        fell into each bin</span>
<span class="sd">        meanu           The mean value :math:`\langle u\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanv           The mean value :math:`\langle v\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        zeta            The estimator :math:`\zeta(r,u,v)` (if rrr is given)</span>
<span class="sd">        sigma_zeta      The sqrt of the variance estimate of :math:`\zeta`</span>
<span class="sd">                        (if rrr is given)</span>
<span class="sd">        DDD             The total weight of DDD triangles in each bin</span>
<span class="sd">        RRR             The total weight of RRR triangles in each bin (if rrr is given)</span>
<span class="sd">        DRR             The total weight of DRR triangles in each bin (if drr is given)</span>
<span class="sd">        RDD             The total weight of RDD triangles in each bin (if rdd is given)</span>
<span class="sd">        ntri            The number of triangles contributing to each bin</span>
<span class="sd">        ==========      ================================================================</span>

<span class="sd">        If ``sep_units`` was given at construction, then the distances will all be in these units.</span>
<span class="sd">        Otherwise, they will be in either the same units as x,y,z (for flat or 3d coordinates) or</span>
<span class="sd">        radians (for spherical coordinates).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):        The name of the file to write to.</span>
<span class="sd">            rrr (NNNCorrelation):   The auto-correlation of the random field (RRR)</span>
<span class="sd">            drr (NNNCorrelation):   DRR if desired. (default: None)</span>
<span class="sd">            rdd (NNNCorrelation):   RDD if desired. (default: None)</span>
<span class="sd">            file_type (str):        The type of file to write (&#39;ASCII&#39; or &#39;FITS&#39;).</span>
<span class="sd">                                    (default: determine the type automatically from the extension</span>
<span class="sd">                                    of file_name.)</span>
<span class="sd">            precision (int):        For ASCII output catalogs, the desired precision. (default: 4;</span>
<span class="sd">                                    this value can also be given in the constructor in the config</span>
<span class="sd">                                    dict.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing NNN correlations to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;r_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;u_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;v_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;meand1&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd1&#39;</span><span class="p">,</span> <span class="s1">&#39;meand2&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd2&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;meand3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanu&#39;</span><span class="p">,</span> <span class="s1">&#39;meanv&#39;</span> <span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">rrr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;rrr must be provided if other combinations are not None&quot;</span><span class="p">)</span>
            <span class="n">col_names</span> <span class="o">+=</span> <span class="p">[</span> <span class="s1">&#39;DDD&#39;</span><span class="p">,</span> <span class="s1">&#39;ntri&#39;</span> <span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This will check for other invalid combinations of rrr, drr, etc.</span>
            <span class="n">zeta</span><span class="p">,</span> <span class="n">varzeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateZeta</span><span class="p">(</span><span class="n">rrr</span><span class="p">,</span><span class="n">drr</span><span class="p">,</span><span class="n">rdd</span><span class="p">)</span>

            <span class="n">col_names</span> <span class="o">+=</span> <span class="p">[</span> <span class="s1">&#39;zeta&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_zeta&#39;</span><span class="p">,</span><span class="s1">&#39;DDD&#39;</span><span class="p">,</span><span class="s1">&#39;RRR&#39;</span> <span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">varzeta</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">rrr</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tot</span><span class="o">/</span><span class="n">rrr</span><span class="o">.</span><span class="n">tot</span><span class="p">)</span> <span class="p">]</span>

            <span class="k">if</span> <span class="n">drr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;DRR&#39;</span><span class="p">,</span><span class="s1">&#39;RDD&#39;</span><span class="p">]</span>
                <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">drr</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tot</span><span class="o">/</span><span class="n">drr</span><span class="o">.</span><span class="n">tot</span><span class="p">),</span> <span class="n">rdd</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tot</span><span class="o">/</span><span class="n">rdd</span><span class="o">.</span><span class="n">tot</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">col_names</span> <span class="o">+=</span> <span class="p">[</span> <span class="s1">&#39;ntri&#39;</span> <span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">precision</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;tot&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
                   <span class="s1">&#39;sep_units&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span><span class="p">,</span> <span class="s1">&#39;bin_type&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="p">}</span>

        <span class="n">gen_write</span><span class="p">(</span>
            <span class="n">file_name</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNNCorrelation.read"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCorrelation.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read in values from a file.</span>

<span class="sd">        This should be a file that was written by TreeCorr, preferably a FITS file, so there</span>
<span class="sd">        is no loss of information.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The `NNNCorrelation` object should be constructed with the same configuration</span>
<span class="sd">            parameters as the one being read.  e.g. the same min_sep, max_sep, etc.  This is not</span>
<span class="sd">            checked by the read function.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):    The name of the file to read in.</span>
<span class="sd">            file_type (str):    The type of file (&#39;ASCII&#39; or &#39;FITS&#39;).  (default: determine the type</span>
<span class="sd">                                automatically from the extension of file_name.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading NNN correlations from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">data</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">gen_read</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logr</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="s1">&#39;R_nom&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;R_nom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;r_nom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rnom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;u_nom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;v_nom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;DDD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntri&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sep_units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bin_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="NNNCrossCorrelation"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation">[docs]</a><span class="k">class</span> <span class="nc">NNNCrossCorrelation</span><span class="p">(</span><span class="n">BinnedCorr3</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;This class handles the calculation a 3-point count-count-count cross-correlation</span>
<span class="sd">    function.</span>

<span class="sd">    For 3-point cross correlations, it matters which of the two or three fields falls on</span>
<span class="sd">    each corner of the triangle.  E.g. is field 1 on the corner opposite d1 (the longest</span>
<span class="sd">    size of the triangle) or is it field 2 (or 3) there?  This is in contrast to the 2-point</span>
<span class="sd">    correlation where the symmetry of the situation means that it doesn&#39;t matter which point</span>
<span class="sd">    is identified with each field.  This makes it significantly more complicated to keep track</span>
<span class="sd">    of all the relevant information for a 3-point cross correlation function.</span>

<span class="sd">    The `NNNCorrelation` class holds a single :math:`\zeta` functions describing all</span>
<span class="sd">    possible triangles, parameterized according to their relative side lengths ordered as</span>
<span class="sd">    d1 &gt; d2 &gt; d3.</span>

<span class="sd">    For a cross-correlation of two fields: N1 - N1 - N2 (i.e. the N1 field is at two of the</span>
<span class="sd">    corners and N2 is at one corner), then we need three these :math:`\zeta` functions</span>
<span class="sd">    to capture all of the triangles, since the N2 points may be opposite d1 or d2 or d3.</span>
<span class="sd">    For a cross-correlation of three fields: N1 - N2 - N3, we need six sets, to account for</span>
<span class="sd">    all of the possible permutations relative to the triangle sides.</span>

<span class="sd">    Therefore, this class holds 6 instances of `NNNCorrelation`, which in turn hold the</span>
<span class="sd">    information about triangles in each of the relevant configurations.  We name these:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        n1n2n3:     Triangles where N1 is opposite d1, N2 is opposite d2, N3 is opposite d3.</span>
<span class="sd">        n1n3n2:     Triangles where N1 is opposite d1, N3 is opposite d2, N2 is opposite d3.</span>
<span class="sd">        n2n1n3:     Triangles where N2 is opposite d1, N1 is opposite d2, N3 is opposite d3.</span>
<span class="sd">        n2n3n1:     Triangles where N2 is opposite d1, N3 is opposite d2, N1 is opposite d3.</span>
<span class="sd">        n3n1n2:     Triangles where N3 is opposite d1, N1 is opposite d2, N2 is opposite d3.</span>
<span class="sd">        n3n2n1:     Triangles where N3 is opposite d1, N2 is opposite d2, N1 is opposite d3.</span>

<span class="sd">    If for instance N2 and N3 are the same field, then e.g. n1n2n3 and n1n3n2 will have</span>
<span class="sd">    the same values.</span>

<span class="sd">    Ojects of this class also hold the following attributes, which are identical in each of</span>
<span class="sd">    the above NNNCorrelation instances.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nbins:      The number of bins in logr where r = d2</span>
<span class="sd">        bin_size:   The size of the bins in logr</span>
<span class="sd">        min_sep:    The minimum separation being considered</span>
<span class="sd">        max_sep:    The maximum separation being considered</span>
<span class="sd">        nubins:     The number of bins in u where u = d3/d2</span>
<span class="sd">        ubin_size:  The size of the bins in u</span>
<span class="sd">        min_u:      The minimum u being considered</span>
<span class="sd">        max_u:      The maximum u being considered</span>
<span class="sd">        nvbins:     The number of bins in v where v = +-(d1-d2)/d3</span>
<span class="sd">        vbin_size:  The size of the bins in v</span>
<span class="sd">        min_v:      The minimum v being considered</span>
<span class="sd">        max_v:      The maximum v being considered</span>
<span class="sd">        logr1d:     The nominal centers of the nbins bins in log(r).</span>
<span class="sd">        u1d:        The nominal centers of the nubins bins in u.</span>
<span class="sd">        v1d:        The nominal centers of the nvbins bins in v.</span>

<span class="sd">    If ``sep_units`` are given (either in the config dict or as a named kwarg) then the distances</span>
<span class="sd">    will all be in these units.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If you separate out the steps of the `process` command and use `process_cross` directly,</span>
<span class="sd">        then the units will not be applied to ``meanr`` or ``meanlogr`` until the `finalize`</span>
<span class="sd">        function is called.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        config (dict):  A configuration dict that can be used to pass in kwargs if desired.</span>
<span class="sd">                        This dict is allowed to have addition entries besides those listed</span>
<span class="sd">                        in `BinnedCorr3`, which are ignored here. (default: None)</span>
<span class="sd">        logger:         If desired, a logger object for logging. (default: None, in which case</span>
<span class="sd">                        one will be built according to the config dict&#39;s verbose level.)</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        **kwargs:       See the documentation for `BinnedCorr3` for the list of allowed keyword</span>
<span class="sd">                        arguments, which may be passed either directly or in the config dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="NNNCrossCorrelation.__init__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize `NNNCrossCorrelation`.  See class doc for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">BinnedCorr3</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d1</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># NData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d2</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># NData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d3</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># NData</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span> <span class="o">=</span> <span class="n">NNNCorrelation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished building NNNCrossCorr&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.__eq__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.__eq__">[docs]</a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether two `NNNCrossCorrelation` instances are equal&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NNNCrossCorrelation</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nbins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bin_size</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_sep</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_sep</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">sep_units</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_u</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_u</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nubins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ubin_size</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_v</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_v</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nvbins</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">vbin_size</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bin_slop</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">xperiod</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">yperiod</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">zperiod</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n1n2n3</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n1n3n2</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n2n1n3</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n2n3n1</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n3n1n2</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n3n2n1</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.copy"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a copy&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">NNNCrossCorrelation</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">NNNCrossCorrelation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">NNNCorrelation</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="c1"># This needs to be the new list:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">n1n2n3</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n1n3n2</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n2n1n3</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n2n3n1</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n3n1n2</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n3n2n1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">_zero_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tot</span><span class="p">):</span>
        <span class="c1"># A minimal &quot;copy&quot; with zero for the weight array, and the given value for tot.</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">NNNCrossCorrelation</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">NNNCrossCorrelation</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">n1n2n3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">n1n3n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">n2n1n3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">n2n3n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">n3n1n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">n3n2n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">n1n2n3</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n1n3n2</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n2n1n3</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n2n3n1</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n3n1n2</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">n3n2n1</span><span class="p">]</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="n">tot</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s1">&#39;_nonzero&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="NNNCrossCorrelation.__repr__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;NNNCrossCorrelation(config=</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.process_cross12"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.process_cross12">[docs]</a>    <span class="k">def</span> <span class="nf">process_cross12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process two catalogs, accumulating the 3pt cross-correlation, where one of the</span>
<span class="sd">        points in each triangle come from the first catalog, and two come from the second.</span>

<span class="sd">        This accumulates the cross-correlation for the given catalogs.  After</span>
<span class="sd">        calling this function as often as desired, the `finalize` command will</span>
<span class="sd">        finish the calculation of meand1, meanlogd1, etc.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This only adds to the attributes n1n2n3, n2n1n3, n2n3n1, not the ones where</span>
<span class="sd">            3 comes before 2.  When running this via the regular `process` method, it will</span>
<span class="sd">            combine them at the end to make sure n1n2n3 == n1n3n2, etc. for a complete</span>
<span class="sd">            calculation of the 1-2 cross-correlation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     The first catalog to process. (1 point in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            cat2 (Catalog):     The second catalog to process. (2 points in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN (1-2) cross-correlations&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN (1-2) cross-correlations for cats </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">cat2</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">f1</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="c1"># Note: all 3 correlation objects are the same.  Thus, all triangles will be placed</span>
        <span class="c1"># into self.corr, whichever way the three catalogs are permuted for each triangle.</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">ProcessCross12</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span>
                            <span class="n">f1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                            <span class="n">f1</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">cat2</span><span class="o">.</span><span class="n">sumw</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.process_cross"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.process_cross">[docs]</a>    <span class="k">def</span> <span class="nf">process_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a set of three catalogs, accumulating the 3pt cross-correlation.</span>

<span class="sd">        This accumulates the cross-correlation for the given catalogs.  After</span>
<span class="sd">        calling this function as often as desired, the `finalize` command will</span>
<span class="sd">        finish the calculation of meand1, meanlogd1, etc.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     The first catalog to process</span>
<span class="sd">            cat2 (Catalog):     The second catalog to process</span>
<span class="sd">            cat3 (Catalog):     The third catalog to process</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat3</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN cross-correlations&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process NNN cross-correlations for cats </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat3</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat3</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">cat2</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">cat3</span><span class="o">.</span><span class="n">getNField</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">f1</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">ProcessCross3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span>
                           <span class="n">f1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f3</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                           <span class="n">f1</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="n">f3</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">cat2</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">cat3</span><span class="o">.</span><span class="n">sumw</span>
        <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span></div>

    <span class="k">def</span> <span class="nf">_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_finalize</span><span class="p">()</span>

<div class="viewcode-block" id="NNNCrossCorrelation.finalize"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalize the calculation of the correlation function.</span>

<span class="sd">        The `process_cross` command accumulate values in each bin, so they can be called</span>
<span class="sd">        multiple times if appropriate.  Afterwards, this command finishes the calculation</span>
<span class="sd">        by dividing by the total weight.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if there are any values accumulated yet.  (i.e. ntri &gt; 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">nnn</span><span class="o">.</span><span class="n">nonzero</span> <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The lazy version when we can be sure the object isn&#39;t going to accumulate any more.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span>

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the data vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">):</span>
        <span class="c1"># Equivalent to the operation of:</span>
        <span class="c1">#     self._clear()</span>
        <span class="c1">#     for other in others:</span>
        <span class="c1">#         self += other</span>
        <span class="c1"># but no sanity checks and use numpy.sum for faster calculation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">tot</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">])</span>
        <span class="c1"># Empty ones were only needed for tot.  Remove them now.</span>
        <span class="n">others</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">_nonzero</span><span class="p">]</span>
        <span class="n">other_all</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">_all</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">])</span> <span class="c1"># Transpose list of lists</span>
        <span class="k">for</span> <span class="n">nnn</span><span class="p">,</span><span class="n">o_nnn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">,</span> <span class="n">other_all</span><span class="p">):</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_sum</span><span class="p">(</span><span class="n">o_nnn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">c2</span><span class="o">.</span><span class="n">sumw</span> <span class="o">*</span> <span class="n">c3</span><span class="o">.</span><span class="n">sumw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>

<div class="viewcode-block" id="NNNCrossCorrelation.__iadd__"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.__iadd__">[docs]</a>    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a second `NNNCrossCorrelation`&#39;s data to this one.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For this to make sense, both `NNNCrossCorrelation` objects should not have had</span>
<span class="sd">            `finalize` called yet.  Then, after adding them together, you should call `finalize`</span>
<span class="sd">            on the sum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NNNCrossCorrelation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can only add another NNNCrossCorrelation object&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">n1n2n3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">n1n3n2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">n2n1n3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">n2n3n1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">n3n1n2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">n3n2n1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">tot</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.getWeight"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.getWeight">[docs]</a>    <span class="k">def</span> <span class="nf">getWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The weight array for the current correlation object as a 1-d array.</span>

<span class="sd">        For NNNCrossCorrelation, this is always just 1.  We don&#39;t currently have any ability</span>
<span class="sd">        to automatically handle a random catalog for NNNCrossCorrelations, so we don&#39;t know</span>
<span class="sd">        what the correct weight would be for a given patch or set of patches.  This value</span>
<span class="sd">        is only used by the sample method of covariance estimation, so this limitation means</span>
<span class="sd">        that sample covariances may be expected to be less accurate than normal when used with</span>
<span class="sd">        NNNCorrelations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">1.</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.process"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Accumulate the cross-correlation of the points in the given Catalogs: cat1, cat2, cat3.</span>

<span class="sd">        - If 2 arguments are given, then compute a cross-correlation function with the</span>
<span class="sd">          first catalog taking one corner of the triangles, and the second taking two corners.</span>
<span class="sd">        - If 3 arguments are given, then compute a three-way cross-correlation function.</span>

<span class="sd">        All arguments may be lists, in which case all items in the list are used</span>
<span class="sd">        for that element of the correlation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     A catalog or list of catalogs for the first N field.</span>
<span class="sd">            cat2 (Catalog):     A catalog or list of catalogs for the second N field.</span>
<span class="sd">            cat3 (Catalog):     A catalog or list of catalogs for the third N field.</span>
<span class="sd">                                (default: None)</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">            comm (mpi4py.Comm): If running MPI, an mpi4py Comm object to communicate between</span>
<span class="sd">                                processes.  If used, the rank=0 process will have the final</span>
<span class="sd">                                computation. This only works if using patches. (default: None)</span>
<span class="sd">            low_mem (bool):     Whether to sacrifice a little speed to try to reduce memory usage.</span>
<span class="sd">                                This only works if using patches. (default: False)</span>
<span class="sd">            initialize (bool):  Whether to begin the calculation with a call to</span>
<span class="sd">                                `BinnedCorr3.clear`.  (default: True)</span>
<span class="sd">            finalize (bool):    Whether to complete the calculation with a call to `finalize`.</span>
<span class="sd">                                (default: True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process12</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">cat1</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">get_patches</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">cat2</span> <span class="o">=</span> <span class="n">cat2</span><span class="o">.</span><span class="n">get_patches</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat3</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">cat3</span> <span class="o">=</span> <span class="n">cat3</span><span class="o">.</span><span class="n">get_patches</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process12</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_cross12</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_cross</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">finalize</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process12</span><span class="p">:</span>
                <span class="c1"># Then some of the processing involved a cross12 calculation.</span>
                <span class="c1"># This means that spots 2 and 3 should not be distinguished.</span>
                <span class="c1"># Combine the relevant arrays.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span>
                <span class="c1"># Copy back by doing clear and +=.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n1n3n2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1n2n3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n3n1n2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n1n3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n3n2n1</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2n3n1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.write"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write the correlation function to the file, file_name.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):    The name of the file to write to.</span>
<span class="sd">            file_type (str):    The type of file to write (&#39;ASCII&#39; or &#39;FITS&#39;).  (default: determine</span>
<span class="sd">                                the type automatically from the extension of file_name.)</span>
<span class="sd">            precision (int):    For ASCII output catalogs, the desired precision. (default: 4;</span>
<span class="sd">                                this value can also be given in the constructor in the config dict.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing NNN cross-correlations to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;r_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;u_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;v_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;meand1&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd1&#39;</span><span class="p">,</span> <span class="s1">&#39;meand2&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd2&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;meand3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanu&#39;</span><span class="p">,</span> <span class="s1">&#39;meanv&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;ntri&#39;</span> <span class="p">]</span>
        <span class="n">group_names</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;n1n2n3&#39;</span><span class="p">,</span> <span class="s1">&#39;n1n3n2&#39;</span><span class="p">,</span> <span class="s1">&#39;n2n1n3&#39;</span><span class="p">,</span> <span class="s1">&#39;n2n3n1&#39;</span><span class="p">,</span> <span class="s1">&#39;n3n1n2&#39;</span><span class="p">,</span> <span class="s1">&#39;n3n2n1&#39;</span> <span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">nnn</span><span class="o">.</span><span class="n">rnom</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                      <span class="n">nnn</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span>
                      <span class="n">nnn</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">meanu</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">meanv</span><span class="p">,</span>
                      <span class="n">nnn</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">nnn</span><span class="o">.</span><span class="n">ntri</span> <span class="p">]</span>
                    <span class="k">for</span> <span class="n">nnn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="p">]</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;tot&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
                   <span class="s1">&#39;sep_units&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span><span class="p">,</span> <span class="s1">&#39;bin_type&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="p">}</span>

        <span class="k">if</span> <span class="n">precision</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">gen_multi_write</span><span class="p">(</span>
            <span class="n">file_name</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="n">group_names</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNNCrossCorrelation.read"><a class="viewcode-back" href="../../nnn.html#treecorr.NNNCrossCorrelation.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read in values from a file.</span>

<span class="sd">        This should be a file that was written by TreeCorr, preferably a FITS file, so there</span>
<span class="sd">        is no loss of information.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The `NNNCrossCorrelation` object should be constructed with the same configuration</span>
<span class="sd">            parameters as the one being read.  e.g. the same min_sep, max_sep, etc.  This is not</span>
<span class="sd">            checked by the read function.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):    The name of the file to read in.</span>
<span class="sd">            file_type (str):    The type of file (&#39;ASCII&#39; or &#39;FITS&#39;).  (default: determine the type</span>
<span class="sd">                                automatically from the extension of file_name.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading NNN cross-correlations from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">group_names</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;n1n2n3&#39;</span><span class="p">,</span> <span class="s1">&#39;n1n3n2&#39;</span><span class="p">,</span> <span class="s1">&#39;n2n1n3&#39;</span><span class="p">,</span> <span class="s1">&#39;n2n3n1&#39;</span><span class="p">,</span> <span class="s1">&#39;n3n1n2&#39;</span><span class="p">,</span> <span class="s1">&#39;n3n2n1&#39;</span> <span class="p">]</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">gen_multi_read</span><span class="p">(</span>
                <span class="n">file_name</span><span class="p">,</span> <span class="n">group_names</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logr</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">group_names</span><span class="p">):</span>
            <span class="n">nnn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;r_nom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nnn</span><span class="o">.</span><span class="n">rnom</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;u_nom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;v_nom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meand1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meanlogd1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meand2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meanlogd2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meand3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">meanv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">ntri</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntri&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sep_units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bin_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">nnn</span><span class="o">.</span><span class="n">tot</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Mike Jarvis.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>